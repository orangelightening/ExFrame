# ExFrame - Expertise Framework
#
# This Docker Compose file sets up:
# - ExFrame App: The main AI-powered knowledge management system
# - Prometheus: Metrics collection and storage
# - Grafana: Visualization dashboards
# - Loki: Log aggregation
# - Promtail: Log shipping agent
#
# NAMING NOTE: Service and volume names use 'eeframe-*' prefix for historical
# reasons (git history, data preservation). All user-facing content uses 'ExFrame'.
# See docs/INDEX.md for full nomenclature history.

version: "3.8"

services:
  eeframe-app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: eeframe-app
    ports:
      - "3000:3000"
    environment:
      # Application settings
      - APP_HOME=/app
      - PYTHONPATH=/app:$PYTHONPATH

      # LLM API Configuration (set these in .env or override here)
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-https://api.openai.com/v1}
      - LLM_MODEL=glm-5.0  # NEW: Zhipu GLM-5.0 released

      # Path configuration (optional, defaults shown)
      - PATTERN_STORAGE_BASE=/app/data/patterns
      - DOMAIN_REGISTRY_PATH=/app/data
      - UNIVERSES_BASE=/app/universes

      # Model cache directory for sentence-transformers
      - TRANSFORMERS_CACHE=/app/cache/models
      - HF_HOME=/app/cache/huggingface

      # Log level
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      # Persist domain registry
      - eeframe_data:/app/data

      # Model cache for sentence-transformers
      - eeframe_cache:/app/cache

      # Mount host pattern directories (bind mount for live sync)
      - ./data/patterns:/app/data/patterns:rw

      # Mount universes directory (bind mount for live sync)
      - ./universes:/app/universes:rw

      # Mount generic_framework subdirectories to override image copies
      - ./generic_framework/core:/app/core:rw
      - ./generic_framework/knowledge:/app/knowledge:rw
      - ./generic_framework/plugins:/app/plugins:rw
      - ./generic_framework/assist:/app/assist:rw
      - ./generic_framework/api:/app/api:rw
      - ./generic_framework/diagnostics:/app/diagnostics:rw
      - ./generic_framework/frontend:/app/frontend:ro
      - ./generic_framework/state:/app/state:rw  # Note: mounts to /app/state, not /app/generic_framework/state

      # Mount tests directory for state machine test suite
      - ./tests:/app/tests:ro

      # Mount built frontend (bind mount for live updates)
      # - ./frontend/dist:/app/frontend/dist:ro  # TEMPORARILY DISABLED TO RESTORE NICE UI

      # Mount project root for document search access
      - .:/app/project:ro

      # Mount user library directories
      - ~/omv-library:/app/omv-library:ro

      # Persist logs (optional - container logs also captured)
      - eeframe_logs:/app/logs
    # DISABLED: Using manual uvicorn instead for development
    # restart: unless-stopped
    restart: "no"
    networks:
      - monitoring
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: exframe-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./config/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./config/prometheus/recording_rules.yml:/etc/prometheus/recording_rules.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--web.enable-lifecycle'
    restart: unless-stopped
    networks:
      - monitoring

  grafana:
    image: grafana/grafana:10.2.2
    container_name: exframe-grafana
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=http://localhost:3001
      - GF_INSTALL_PLUGINS=
    volumes:
      - grafana_data:/var/lib/grafana
      - ./config/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./config/grafana/dashboards:/var/lib/grafana/dashboards:ro
    restart: unless-stopped
    networks:
      - monitoring
    depends_on:
      - prometheus

  loki:
    image: grafana/loki:2.9.2
    container_name: exframe-loki
    ports:
      - "3100:3100"
    volumes:
      - ./config/loki/config.yml:/etc/loki/local-config.yaml:ro
      - loki_data:/loki
    command: -config.file=/etc/loki/local-config.yaml
    restart: unless-stopped
    networks:
      - monitoring

  promtail:
    image: grafana/promtail:2.9.2
    container_name: exframe-promtail
    volumes:
      - ./config/promtail/config.yml:/etc/promtail/config.yml:ro
      - /var/log:/var/log:ro  # Mount host logs for collection
      - /var/run/docker.sock:/var/run/docker.sock:ro
    command: -config.file=/etc/promtail/config.yml
    restart: unless-stopped
    networks:
      - monitoring
    depends_on:
      - loki

  # Optional: node_exporter for system metrics
  # Run this on your host system to monitor the ExFrame host itself
  # Uncomment if you want to monitor the host running ExFrame
  # node_exporter:
  #   image: prom/node-exporter:v1.7.0
  #   container_name: exframe-node-exporter
  #   ports:
  #     - "9100:9100"
  #   volumes:
  #     - /proc:/host/proc:ro
  #     - /sys:/host/sys:ro
  #     - /:/rootfs:ro
  #   command:
  #     - '--path.procfs=/host/proc'
  #     - '--path.sysfs=/host/sys'
  #     - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
  #   restart: unless-stopped
  #   networks:
  #     - monitoring

volumes:
  # ExFrame application volumes
  eeframe_data:
    driver: local
    name: eeframe_data
  eeframe_cache:
    driver: local
    name: eeframe_cache
  eeframe_history:
    driver: local
    name: eeframe_history
  eeframe_logs:
    driver: local
    name: eeframe_logs

  # Monitoring volumes
  prometheus_data:
    driver: local
  grafana_data:
    driver: local
  loki_data:
    driver: local

networks:
  monitoring:
    driver: bridge
